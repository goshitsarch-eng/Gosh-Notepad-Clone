name: Build Flatpak

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Build Linux"]
    types:
      - completed

permissions:
  actions: read
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build-flatpak:
    runs-on: ubuntu-latest
    if: >-
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' &&
       startsWith(github.event.workflow_run.head_branch, 'v'))
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Linux AppImage (from workflow_run)
        if: github.event_name == 'workflow_run'
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: build-linux.yml
          name: linux-appimage
          path: flatpak-build

      - name: Download Linux AppImage (manual trigger)
        if: github.event_name == 'workflow_dispatch'
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: build-linux.yml
          name: linux-appimage
          path: flatpak-build

      - name: Extract AppImage
        run: |
          chmod +x flatpak-build/*.AppImage
          cd flatpak-build
          ./*.AppImage --appimage-extract
          # Debug: show structure
          echo "=== AppImage contents ==="
          find squashfs-root -type f -executable | head -20
          ls -la squashfs-root/
          ls -la squashfs-root/usr/bin/ 2>/dev/null || true
          # Find and copy the binary
          BINARY=$(find squashfs-root -type f -executable ! -name "*.so*" ! -name "ld-*" | grep -v lib | head -1)
          echo "Found binary: $BINARY"
          cp "$BINARY" ../flatpak/gosh-notepad
          cd ..

      - name: Install Flatpak
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder
          sudo flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
          sudo flatpak install -y flathub org.gnome.Platform//49 org.gnome.Sdk//49

      - name: Build Flatpak
        run: |
          flatpak-builder --force-clean --repo=repo build-dir flatpak/com.goshitsarch.notepad.yml
          flatpak build-bundle repo notepad.flatpak com.goshitsarch.notepad

      - name: Rename Flatpak with version
        run: |
          TAG="${{ github.event.workflow_run.head_branch }}"
          if [ -z "$TAG" ]; then
            TAG="${GITHUB_REF_NAME:-latest}"
          fi
          mv notepad.flatpak "notepad-${TAG}-x86_64.flatpak"
          echo "FLATPAK_FILE=notepad-${TAG}-x86_64.flatpak" >> $GITHUB_ENV

      - name: Upload Flatpak
        uses: actions/upload-artifact@v4
        with:
          name: linux-flatpak
          path: notepad-*-x86_64.flatpak
          if-no-files-found: error

      - name: Upload to GitHub Release
        if: github.event_name == 'workflow_run' && startsWith(github.event.workflow_run.head_branch, 'v')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.workflow_run.head_branch }}
          files: notepad-*-x86_64.flatpak
